<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Title</title>
    <meta name="description" content="Content description">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="css/leaflet.css"/>
    <script type="text/javascript" src="js/leaflet.js"></script>
    <script type="text/javascript" src="js/outline-map.js"></script>
    <script type="text/javascript" src="js/homicide-map.js"></script>
    <script type="text/javascript" src="js/map-data-crime.js"></script>
    <script type="text/javascript" src="js/police-camera.js"></script>
    <script type="text/javascript" src="js/estimate-camera.js"></script>
    <script type="text/javascript" src="js/streets-camera.js"></script>
  </head>

<style>
body {
  font-family: Lato;
  font-size: 112.5%;
  line-height: 1.1em;
  color: black;
} 
#wrapper {
  border:1px solid #D3D3D3;
  max-width: 800px;  /*MODIFY: set the maximum width of the map.*/
  margin: 0 auto;
}
.head {padding:10px;}
.mapbox { 
  height: 800px; 
  width: 100%;
  margin-bottom: 20px;
}
.headline {
  font-style: normal;
  font-size: 24px;
  font-weight: 400;
  padding-bottom: 10px;
  padding-top: 10px;
}
#text {
  font-size: 18px;
  font-weight: normal;
  line-height: 18px;
}
.leaflet-popup-close-button {
  display: none;
}

.legend {
	line-height: 18px;
	color: #555;
  background-color: rgba(256, 256, 256, 0.6);
  padding:5px;
}
.legend i, .legend-homicide {
	width: 10px;
	height: 10px;
	float: left;
  margin:4px;
	margin-right: 8px;
}

.legend-homicide {
  position: relative;
}

.legend-homicide img {
  position: absolute;
  top: 50%;
  left: 50%;
  margin-left: -5px;
  margin-top: -5px; 
}

.legend-camera {
  border-radius: 50%;
}

@media (max-width: 500px ) {
  .headline {font-size: 16px; line-height: 20px; padding-bottom: 0px;}
  #text {font-size: 13px;line-height: 15px;padding-bottom: 3px;}
}
@media (max-width: 400px ) { 
}
</style>
</head>
<body>

<div id="wrapper"> 
    <div class="head">
        <div class="headline">Race and Income</div>
        <div id="text">Description: Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</div> 
    </div>   
    <div class="mapbox" id="map-container">
    </div>
</div>    

<script type="text/javascript">
var zoomlevel;
if(window.innerWidth<500){
  zoomlevel = 11;
} else {
  zoomlevel = 13;
}

var mymap = L.map('map-container').setView([38.634621, -90.239395], zoomlevel);
L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}{r}.png', {
	attribution: '<a href="https://wikimediafoundation.org/wiki/Maps_Terms_of_Use">Wikimedia</a>',
	minZoom: 1,
	maxZoom: 19
}).addTo(mymap);

//Style map
function getRaceColor(d) {
    return d == "No population" ? '#ffffff' :
           d > 0.8  ? '#4a1486' :
           d > 0.6  ? '#6a51a3' :
           d > 0.4  ? '#807dba' :
           d > 0.2  ? '#9e9ac8' :
                      '#bcbddc';
}

function raceStyle(feature) {
    return {
        fillColor: getRaceColor(feature.properties.black),
        weight: 1,
        opacity: 1,
        color: 'white',
        fillOpacity: 0.5
    };
}

function getIncomeColor(d) {
    return d == "No population" ? '#ffffff' :
           d == "N/A" ? '#808080' :
           d > 89999  ? '#fc9272' :
           d > 69999  ? '#fb6a4a' :
           d > 49999   ? '#ef3b2c' :
           d > 29999   ? '#cb181d' :
           d > 9999   ? '#a50f15' :
                      '#67000d';
}

function incomeStyle(feature) {
    return {
        fillColor: getIncomeColor(feature.properties.income),
        weight: 1,
        opacity: 1,
        color: 'white',
        fillOpacity: 0.5
    };
}

function emptyStyle(feature) {
    return {
        fillColor: '#ffffff',
        weight: 2,
        opacity: 1,
        color: '#464646',
        fillOpacity: 0
    };
}

//style marker for homicide
var homicideIcon = L.icon({
    iconUrl: 'js/icon-cross.png',
    iconSize: [10, 10],
    iconAnchor: [5, 5],
    popupAnchor: [-5, -5],
});

//create pane to fix the zindex of the 2 base layers (race and income)
mymap.createPane('six');
mymap.createPane('five');
mymap.createPane('four');

var policeStyle = {
    radius: 5,
    fillColor: "#0376B4",
    color: "#0376B4",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.5
};
var streetsStyle = {
    radius: 5,
    fillColor: "#f5c11f",
    color: "#f5c11f",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.5
};
var estimateStyle = {
    radius: 5,
    fillColor: "#696969",
    color: "#696969",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.5
};

//Set up base layers
var layerIncome = L.geoJSON(dataMap, {
    style: incomeStyle,
    onEachFeature: onIncomeBlock,
    pane: 'five'
});
var layerRace = L.geoJSON(dataMap, {
    style: raceStyle,
    onEachFeature: onRaceBlock,
    pane: 'four'
});
var layerEmpty = L.geoJSON(outlineMap, {
    style: emptyStyle,
    pane: 'six'
});

//colect both base layers into an array
var baseMaps = {
    "Income": layerIncome,
    "Race": layerRace,
    "Clear map": layerEmpty,
};
//setup popup for camera layer
function onEachCamera(feature, layer) {
        layer.bindPopup("<b>Camera</b><br>Location: " + feature.properties.Location_Clean);
}

//setup popup for homicide layer
function onEachHomicide(feature, layer) {
        layer.bindPopup("<b>Homicide</b><br>Date/Time: " + feature.properties.DateOccur);
}

//Set up camera layers
var layerPolice = L.geoJSON(policeCamera, {
  pointToLayer: (geoJsonPoint, latlng) => {
    return L.circleMarker(latlng, policeStyle);
  },
  onEachFeature: onEachCamera,
});
var layerStreets = L.geoJSON(streetsCamera, {
  pointToLayer: (geoJsonPoint, latlng) => {
    return L.circleMarker(latlng, streetsStyle);
  },
  onEachFeature: onEachCamera,
});
var layerEstimate = L.geoJSON(estimateCamera, {
  pointToLayer: (geoJsonPoint, latlng) => {
    return L.circleMarker(latlng, estimateStyle);
  },
  onEachFeature: onEachCamera,
});

//set up homicide layer
var layerHomicide = L.geoJSON(homicideMap, {
  pointToLayer: (geoJsonPoint, latlng) => {
    return L.marker(latlng, {icon: homicideIcon});
    // return L.circleMarker(latlng, homicideStyle);
  },
  onEachFeature: onEachHomicide,
});

//colect all camera layers into an array
var cameraMaps = {
    "Police cameras": layerPolice,
    "Street cameras": layerStreets,
    "Estimated cameras": layerEstimate,
    "Homicide": layerHomicide
};

//Preload income map
layerRace.addTo(mymap);

//Load control panel that has both base maps and camera maps option
var control = L.control.layers(baseMaps, cameraMaps).addTo(mymap);
mymap.getPane('four').style.zIndex = 300;
mymap.getPane('five').style.zIndex = 300;
mymap.getPane('six').style.zIndex = 300;

//mouseover interaction
var lastClickedIncome = null;
function highlightIncome(feature, layer) {
    //return the previous polygon to its original style
    if (lastClickedIncome !== null) {
      lastClickedIncome.setStyle({
        weight: 1,
        color: 'white',
        fillOpacity: 0.5
      });
    }
    var thisIncome = this;
    this.setStyle({
        weight: 2,
        color: '#333',
        fillOpacity: 0.7
    });
    this.bindPopup(this.feature.properties.name + "<br>Median household income: <b>" + formatIncome(this.feature.properties.income) + "</b>").openPopup();
    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
      this.bringToFront();
    }
    lastClickedIncome = thisIncome;
}
var lastClickedRace = null;
function highlightRace(feature, layer) {
    //return the previous polygon to its original style
    if (lastClickedRace !== null) {
      lastClickedRace.setStyle({
        weight: 1,
        color: 'white',
        fillOpacity: 0.5
      });
    }
    var thisRace = this;
    this.setStyle({
        weight: 2,
        color: '#333',
        fillOpacity: 0.7
    });
    this.bindPopup(this.feature.properties.name + "<br>Black percentage: <b>" + formatRace(this.feature.properties.black) + "</b>" + "<br>Black population: <b>" + formatIncome2(this.feature.properties.black_pop)).openPopup();
    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        this.bringToFront();
    }
    lastClickedRace = thisRace;
}

function resetIncome(e) {
    this.closePopup();
    layerIncome.resetStyle(e.target);
}
function resetRace(e) {
    this.closePopup();
    layerRace.resetStyle(e.target);
}

function onIncomeBlock(feature, layer) {
    layer.on({
        mouseover: highlightIncome,
        mouseout: resetIncome,
        click: highlightIncome,
    });
}
function onRaceBlock(feature, layer) {
    layer.on({
        mouseover: highlightRace,
        mouseout: resetRace,
        click: highlightRace,
    });
}

//thousand separator function
function formatIncome(num) {
  if (num == "No population"){ return "No population"}
    else if (num == "N/A"){ return "N/A"}
    else {return "$" + num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')}
}
function formatIncome2(num) {
  if (num == "No population"){ return "No population"}
    else if (num == "N/A"){ return "N/A"}
    else {return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')}
}
function formatRace(num) {
  if (num == "No population"){ return "No population"}
    else {return (num*100).toFixed(1) + "%"}
}
function formatLegendRace1(num) {
  if (num == "No population"){ return "No population"}
    else {return (num*100).toFixed(0)}
}
function formatLegendRace2(num) {
  if (num == "No population"){ return "No population"}
    else {return (num*100).toFixed(0) + "%"}
}

//setup legend

var legendIncome = L.control({position: 'bottomright'});
legendIncome.onAdd = function (map) {
	var div = L.DomUtil.create('div', 'info legend'),
		grades = [0, 10000, 30000, 50000, 70000, 90000],
		labels = [];
  div.innerHTML += '<b>Median household income</b><br>';
	// loop through our density intervals and generate a label with a colored square for each interval
	for (var i = 0; i < grades.length; i++) {
		div.innerHTML +=
			'<i style="background:' + getIncomeColor(grades[i] + 1) + '"></i> ' +
			formatIncome(grades[i]) + formatIncome2(grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
	}
	return div;
};

var legendRace = L.control({position: 'bottomright'});
legendRace.onAdd = function (map) {
	var div = L.DomUtil.create('div', 'info legend'),
		grades = [0, 0.2, 0.4, 0.6, 0.8],
		labels = [];
  div.innerHTML += '<b>Black population</b><br>';
	// loop through our density intervals and generate a label with a colored square for each interval
	for (var i = 0; i < grades.length; i++) {
		div.innerHTML +=
			'<i style="background:' + getRaceColor(grades[i]+0.1) + '"></i> ' +
			formatLegendRace1(grades[i]) + (grades[i + 1] ? '&ndash;' + formatLegendRace2(grades[i + 1]) + '<br>' : '%+');
	}
	return div;
};

var legendCamera = L.control({position: 'bottomleft'});
legendCamera.onAdd = function (map) {
	var div = L.DomUtil.create('div', 'info legend');
  div.innerHTML += '<i style="background:#0376B4" class="legend-camera"></i>Police camera<br><i style="background:#f5c11f" class="legend-camera"></i>Street camera<br><i style="background:#696969" class="legend-camera"></i>Estimated camera<br><div class="legend-homicide"><img src="js/icon-cross.png" height="10px" width="10px"></div>Homicide<br>';
	return div;
};

legendRace.addTo(mymap);
legendCamera.addTo(mymap);

// Add and remove layers
mymap.on('baselayerchange', function (eventLayer) {
    // Switch to the legend...
    if (eventLayer.name === 'Income') {
        mymap.removeControl(legendRace);
        legendIncome.addTo(mymap);
    } else if (eventLayer.name === 'Race') { // Or switch to the treeline legend...
        mymap.removeControl(legendIncome);
        legendRace.addTo(mymap);
    } else {
        mymap.removeControl(legendIncome);
        mymap.removeControl(legendRace);
    }
});




</script>

</body>
</html>